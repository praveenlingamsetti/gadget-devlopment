{"version":3,"sources":["/var/gadget/codegen/framework-1729659914536-oIXGhE/src/ai/index.ts"],"sourcesContent":["import { Readable, type ReadableOptions } from \"stream\";\n\nclass OpenAIResponseStream extends Readable {\n  readonly openAIIterable: AsyncIterable<any>;\n  reading: boolean;\n  result: string;\n  responseContentType = \"application/octet-stream\";\n\n  constructor(openAIIterable: AsyncIterable<any>, options: ReadableOptions = {}) {\n    super(options);\n    this.openAIIterable = openAIIterable;\n    this.reading = false;\n    this.result = \"\";\n  }\n\n  processChunk(): (chunk: any) => string | undefined {\n    let isFunctionStreaming: boolean;\n\n    return (json) => {\n      if (json.choices[0]?.delta?.function_call?.name) {\n        isFunctionStreaming = true;\n        return `{\"function_call\": {\"name\": \"${json.choices[0]?.delta?.function_call.name}\", \"arguments\": \"`;\n      }\n\n      if (json.choices[0]?.delta?.function_call?.arguments) {\n        const argumentChunk: string = json.choices[0].delta.function_call.arguments;\n\n        const escapedPartialJson = argumentChunk\n          .replace(/\\\\/g, \"\\\\\\\\\") // Replace backslashes first to prevent double escaping\n          .replace(/\\//g, \"\\\\/\") // Escape slashes\n          .replace(/\"/g, '\\\\\"') // Escape double quotes\n          .replace(/\\n/g, \"\\\\n\") // Escape new lines\n          .replace(/\\r/g, \"\\\\r\") // Escape carriage returns\n          .replace(/\\t/g, \"\\\\t\") // Escape tabs\n          .replace(/\\f/g, \"\\\\f\"); // Escape form feeds\n\n        return `${escapedPartialJson}`;\n      }\n\n      if (isFunctionStreaming && (json.choices[0]?.finish_reason === \"function_call\" || json.choices[0]?.finish_reason === \"stop\")) {\n        isFunctionStreaming = false;\n        return '\"}}';\n      }\n\n      return json.choices?.[0]?.delta?.content ?? json.choices?.[0]?.text;\n    };\n  }\n\n  // eslint-disable-next-line @typescript-eslint/no-misused-promises\n  async _read() {\n    if (this.reading) return;\n    this.reading = true;\n    const process = this.processChunk();\n\n    try {\n      for await (const part of this.openAIIterable) {\n        const content = process(part);\n        if (content) {\n          this.result += content;\n          this.push(content);\n        }\n      }\n\n      this.push(null);\n      this.reading = false;\n    } catch (err) {\n      this.emit(\"error\", err);\n    }\n  }\n}\n\n/**\n * Represents options for the OpenAI response stream.\n */\nexport interface OpenAIResponseStreamOptions {\n  /**\n   * A callback function that will be invoked when the OpenAI response stream is complete.\n   * @param {string} content - The full output of the LLM response.\n   */\n  onComplete?: (content: string) => void;\n}\n\n/**\n * Converts the result of calling openai with `stream: true` into a readable stream that\n * Fasitfy can respond with.\n *\n *\n * @param {AsyncIterable<any>} stream - An AsyncIterable containing OpenAI response parts.\n * @param {OpenAIResponseStreamOptions} options - Options for the OpenAI response stream.\n * @returns {Readable} A Readable stream with the transformed content from the input stream.\n *\n *\n * @example\n * // Using the openAIResponseStream function to convert an AsyncIterable into a Readable stream\n * const stream = await connections.openai.chat.completions.create({\n *   model: \"gpt-3.5-turbo\",\n *   messages: [{ role: \"user\", content: \"Hello!\" }],\n *   stream: true,\n * });\n * await reply.send(openAIResponseStream(stream, {\n *  onComplete: (content) => { console.log(content) }\n * }));\n *\n * @see {@link https://github.com/openai/openai-node} - OpenAI Node.js client library.\n * @see {@link https://docs.gadget.dev/guides/http-routes/route-configuration#sending-responses} - Sending responses in Gadget.\n */\nexport function openAIResponseStream(openAIIterable: AsyncIterable<any>, options: OpenAIResponseStreamOptions = {}): Readable {\n  const stream = new OpenAIResponseStream(openAIIterable);\n\n  stream.on(\"end\", () => {\n    if (options.onComplete) options.onComplete(stream.result);\n  });\n\n  return stream;\n}\n"],"names":["openAIResponseStream","OpenAIResponseStream","Readable","processChunk","isFunctionStreaming","json","choices","delta","function_call","name","arguments","argumentChunk","escapedPartialJson","replace","finish_reason","content","text","_read","reading","process","part","openAIIterable","result","push","err","emit","constructor","options","responseContentType","stream","on","onComplete"],"mappings":";;;;+BA0GgBA;;;eAAAA;;;wBA1G+B;;;;;;;;;;;;;;AAE/C,MAAMC,6BAA6BC,gBAAQ;IAazCC,eAAmD;QACjD,IAAIC;QAEJ,OAAO,CAACC;YACN,IAAIA,KAAKC,OAAO,CAAC,EAAE,EAAEC,OAAOC,eAAeC,MAAM;gBAC/CL,sBAAsB;gBACtB,OAAO,CAAC,4BAA4B,EAAEC,KAAKC,OAAO,CAAC,EAAE,EAAEC,OAAOC,cAAcC,KAAK,iBAAiB,CAAC;YACrG;YAEA,IAAIJ,KAAKC,OAAO,CAAC,EAAE,EAAEC,OAAOC,eAAeE,WAAW;gBACpD,MAAMC,gBAAwBN,KAAKC,OAAO,CAAC,EAAE,CAACC,KAAK,CAACC,aAAa,CAACE,SAAS;gBAE3E,MAAME,qBAAqBD,cACxBE,OAAO,CAAC,OAAO,QAAQ,uDAAuD;gBAC9EA,OAAO,CAAC,OAAO,OAAO,iBAAiB;gBACvCA,OAAO,CAAC,MAAM,OAAO,uBAAuB;gBAC5CA,OAAO,CAAC,OAAO,OAAO,mBAAmB;gBACzCA,OAAO,CAAC,OAAO,OAAO,0BAA0B;gBAChDA,OAAO,CAAC,OAAO,OAAO,cAAc;gBACpCA,OAAO,CAAC,OAAO;gBAAQ,oBAAoB;gBAE9C,OAAO,GAAGD,oBAAoB;YAChC;YAEA,IAAIR,uBAAwBC,CAAAA,KAAKC,OAAO,CAAC,EAAE,EAAEQ,kBAAkB,mBAAmBT,KAAKC,OAAO,CAAC,EAAE,EAAEQ,kBAAkB,MAAK,GAAI;gBAC5HV,sBAAsB;gBACtB,OAAO;YACT;YAEA,OAAOC,KAAKC,OAAO,EAAE,CAAC,EAAE,EAAEC,OAAOQ,WAAWV,KAAKC,OAAO,EAAE,CAAC,EAAE,EAAEU;QACjE;IACF;IAEA,kEAAkE;IAClE,MAAMC,QAAQ;QACZ,IAAI,IAAI,CAACC,OAAO,EAAE;QAClB,IAAI,CAACA,OAAO,GAAG;QACf,MAAMC,UAAU,IAAI,CAAChB,YAAY;QAEjC,IAAI;YACF,WAAW,MAAMiB,QAAQ,IAAI,CAACC,cAAc,CAAE;gBAC5C,MAAMN,UAAUI,QAAQC;gBACxB,IAAIL,SAAS;oBACX,IAAI,CAACO,MAAM,IAAIP;oBACf,IAAI,CAACQ,IAAI,CAACR;gBACZ;YACF;YAEA,IAAI,CAACQ,IAAI,CAAC;YACV,IAAI,CAACL,OAAO,GAAG;QACjB,EAAE,OAAOM,KAAK;YACZ,IAAI,CAACC,IAAI,CAAC,SAASD;QACrB;IACF;IA5DAE,YAAYL,cAAkC,EAAEM,UAA2B,CAAC,CAAC,CAAE;QAC7E,KAAK,CAACA,UANR,uBAASN,kBAAT,KAAA,IACAH,uBAAAA,WAAAA,KAAAA,IACAI,uBAAAA,UAAAA,KAAAA,IACAM,uBAAAA,uBAAsB;QAIpB,IAAI,CAACP,cAAc,GAAGA;QACtB,IAAI,CAACH,OAAO,GAAG;QACf,IAAI,CAACI,MAAM,GAAG;IAChB;AAwDF;AAEA;;CAEC,GAEC;;;GAGC,GAIH;;;;;;;;;;;;;;;;;;;;;;;CAuBC,GACM,SAAStB,qBAAqBqB,cAAkC,EAAEM,UAAuC,CAAC,CAAC;IAChH,MAAME,SAAS,IAAI5B,qBAAqBoB;IAExCQ,OAAOC,EAAE,CAAC,OAAO;QACf,IAAIH,QAAQI,UAAU,EAAEJ,QAAQI,UAAU,CAACF,OAAOP,MAAM;IAC1D;IAEA,OAAOO;AACT"}